<div class="topbar-item">
  <div ngbDropdown>
    <button class="topbar-link dropdown-toggle drop-arrow-none" ngbDropdownToggle type="button">
      <ng-icon name="lucideBell" class="fs-xxl" />
      @if (getCantidadNoLeidas() > 0) {
      <span class="badge badge-square text-bg-success topbar-badge">{{ getCantidadNoLeidas() }}</span>
      }
    </button>

    <div class="dropdown-menu dropdown-menu-end notification-dropdown shadow-lg border-0" ngbDropdownMenu>
      <!-- Header -->
      <div class="notification-header d-flex justify-content-between align-items-center px-4 py-3">
        <h2 class="fw-bold text-dark mb-0" style="font-size: 22px; letter-spacing: -0.02em;">Notificaciones</h2>
        <div class="d-flex align-items-center gap-3">
          <button #settingsPopover="ngbPopover" [ngbPopover]="settingsTemplate" [autoClose]="'outside'"
            placement="bottom-end" container="body" class="btn btn-link text-muted p-0 border-0"
            style="transition: color 0.2s ease;">
            <ng-icon name="lucideSettings" style="width: 20px; height: 20px;" />
          </button>

          <ng-template #settingsTemplate>
            <div class="p-2" style="min-width: 220px;">
              <div class="d-flex align-items-center justify-content-between cursor-pointer px-2 py-2 rounded"
                (click)="markAllAsRead(); settingsPopover.close()" style="transition: background-color 0.2s;"
                onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'"
                onmouseout="this.style.backgroundColor='transparent'">
                <span class="text-dark" style="font-size: 14px; font-weight: 500;">Marcar como leídas</span>
                <ng-icon name="lucideCheck" class="text-muted" style="width: 18px; height: 18px;" />
              </div>

              <hr class="my-2 opacity-10">

              <div class="d-flex align-items-center justify-content-between px-2 py-1">
                <label class="form-label mb-0" style="font-size: 14px; font-weight: 500;">Solo no leídas</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="toggleNoLeidas"
                    [checked]="verSoloNoLeidas" (change)="onToggleNoLeidas($event); settingsPopover.close()">
                </div>
              </div>
            </div>
          </ng-template>
        </div>
      </div>

      <!-- Notification List -->
      <ngx-simplebar style="max-height: 450px;">
        @if (notifications && notifications.length > 0) {
        @for (notification of notifications; track notification.id) {
        <article class="notification-item d-flex align-items-start gap-3 px-3 py-3 cursor-pointer"
          [class.notification-unread]="!notification.leida" [class.notification-read]="notification.leida"
          (click)="navigateToTarget(notification)">
          <!-- Icon -->
          <!-- @if (notification.accion || notification.asunto) {
                <div class="notification-icon flex-shrink-0 rounded-circle d-flex align-items-center justify-center"
                     [class.icon-unread]="!notification.leida"
                     [class.icon-read]="notification.leida"
                >
                  <ng-icon [name]="getIconNameAccion(notification.accion || notification.asunto || '')" style="width: 24px; height: 24px;" />
                </div>
              } -->

          <!-- Content -->
          <div class="flex-grow-1" style="min-width: 0;">
            <p class="notification-text mb-0" [innerHTML]="notification.mensaje"></p>
            <span class="notification-time d-block" style="font-size: 12px; color: #6b7280; font-weight: 500;">
              {{ getTimeAgo(notification.createdAt || notification.fecha) }}
            </span>
          </div>

          <!-- Checkmark -->
          <div class="flex-shrink-0 d-flex align-items-center justify-content-center"
            (click)="toggleLida(notification); $event.stopPropagation()"
            style="width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease;"
            [style.background-color]="notification.leida ? 'rgba(34, 197, 94, 0.1)' : 'transparent'"
            (mouseenter)="onCheckmarkHover($event, notification.leida)"
            (mouseleave)="onCheckmarkLeave($event, notification.leida)">
            <ng-icon name="lucideCheck" class="notification-check" [class.text-success]="notification.leida"
              [class.text-muted]="!notification.leida" style="width: 18px; height: 18px;" />
          </div>
        </article>
        }
        } @else {
        <div class="text-center py-5 text-muted">
          <ng-icon name="lucideBellOff" class="mb-2" style="width: 48px; height: 48px; opacity: 0.3;" />
          <p class="mb-0">No tienes notificaciones</p>
        </div>
        }
      </ngx-simplebar>
    </div>
  </div>
</div>