<div class="container container-modal">


    <div class="mb-3">
        <p [innerHTML]="mensajeHtml" class="mb-0 text-muted"></p>
    </div>

    <div class="d-flex gap-3 mb-3 justify-content-center align-items-center">

        @if(etapaActual) {
            <div class="w-100">
                @switch (modo) {
                    @default {
                        <label class="form-label">Etapa Actual</label>
                    }
                    @case ('RTO') {
                        <label class="form-label">Etapa a retroceder</label>
                    }
                    @case ('REC') {
                        <label class="form-label">Rechaza en la etapa</label>
                    }
                }
                <input class="form-control" type="text" [value]="etapaActual" disabled>
            </div>
        }
        @if(proximaEtapa) {
            <div class="d-flex align-items-flex-end h-100">
                <div class="">
                    @switch (modo) {
                        @default {
                            <ng-icon name="lucideArrowBigRightDash" color="gray" style="width: 24px; height: 24px;"/>
                        }
                        @case ('RTO') {
                            <ng-icon name="lucideArrowBigLeftDash" color="gray" style="width: 24px; height: 24px;"/>
                        }
                        @case ('REC') {
                            <ng-icon name="lucideX" color="gray" style="width: 24px; height: 24px;"/>
                        }
                    }
                </div>
            </div>
            <div class="w-100">
                @switch (modo) {
                    @default {
                        <label class="form-label">Próxima Etapa</label>
                    }
                    @case ('RTO') {
                        <label class="form-label">Etapa Actual</label>
                    }
                    @case ('REC') {
                        <label class="form-label">Etapa de rechazo</label>
                    }

                }
                <input class="form-control" type="text" [value]="proximaEtapa" disabled>
            </div>
        }

    </div>

    @if(requisitos && requisitos.length > 0) {
    <div class="mb-3">
        <label class="form-label mb-2">Requisitos de la Etapa</label>
        <p-table 
            [value]="requisitos" 
            [tableStyle]="{ 'min-width': '100%' }"
            styleClass="p-datatable-sm p-datatable-gridlines"
        >
            <ng-template #header>
                <tr>
                    <th>Requisito</th>
                    <th>Valor</th>
                </tr>
            </ng-template>
            <ng-template #body let-requisito>
                <tr>
                    <td>
                        <div [class.fw-semibold]="requisito.obligatorio">
                            {{ requisito.descripcion }}
                            @if(requisito.obligatorio) {
                                <span class="text-danger">*</span>
                            }
                        </div>
                        @if(requisito.codigo) {
                            <small class="text-muted">{{ requisito.codigo }}</small>
                        }
                    </td>
                    <td>
                        @if(requisito.tipo?.toLowerCase() === 'boolean') {
                            <div class="form-check">
                                <input 
                                    type="checkbox" 
                                    class="form-check-input"
                                    [(ngModel)]="requisitosValores[requisito.id]"
                                    [id]="'check-' + requisito.id"
                                />
                                <label class="form-check-label" [for]="'check-' + requisito.id">
                                    Sí/No
                                </label>
                            </div>
                        } @else {
                            <input 
                                [type]="getInputType(requisito.tipo)"
                                class="form-control form-control-sm"
                                [(ngModel)]="requisitosValores[requisito.id]"
                                [placeholder]="getPlaceholder(requisito)"
                            />
                        }
                    </td>
                </tr>
            </ng-template>
            <ng-template #emptymessage>
                <tr>
                    <td colspan="3" class="text-center text-muted py-3">
                        No hay requisitos definidos
                    </td>
                </tr>
            </ng-template>
        </p-table>
        <small class="text-muted">Los campos marcados con <span class="text-danger">*</span> son obligatorios.</small>
    </div>
    }

    @if(modo !== 'REC') {
    <div class="mb-3">
        <label for="usuario" class="form-label">Usuario</label>
        <!-- <p-select 
            id="usuario"
            [(ngModel)]="usuario"
            [options]="usuariosOptions"
            optionLabel="nombre"
            placeholder="Buscar usuario..."
            [filter]="true"
            filterPlaceholder="Buscar..."
            [showClear]="true"
            styleClass="w-100"
        /> -->
        <div class="card flex justify-center">
            <p-select
                id="usuario"
                [options]="usuarios"
                [(ngModel)]="usuario"
                optionLabel="usuario"
                [filter]="true"
                filterBy="usuario,nombre,apellido"
                [showClear]="true"
                placeholder="Seleccionar usuario"
                class="w-full md:w-56"
            >
                <ng-template #selectedItem let-selectedOption>
                    <div class="flex items-center gap-2">
                        <div>{{ `${selectedOption.usuario} | ${selectedOption.nombre} ${selectedOption.apellido}` }}</div>
                    </div>
                </ng-template>
                <ng-template let-usuario #item>
                        <div class="flex items-center gap-2">
                        <div>{{ `${usuario.usuario} | ${usuario.nombre} ${usuario.apellido}` }}</div>
                    </div>
                </ng-template>
            </p-select>
        </div>
        <div class="form-text">Asigna al siguiente responsable.</div>
    </div>
    }

    <div class="mb-3">
        <label for="comentario" class="form-label">Comentario</label>
        <textarea id="comentario" class="form-control" rows="5"
            placeholder="Agrega detalles relevantes..." [(ngModel)]="comentario"></textarea>
    </div>

    <div class="mt-4">
        <button class="btn btn-success w-100 py-2" (click)="seleccionar($event)">
            ✓ Confirmar
        </button>
    </div>
</div>