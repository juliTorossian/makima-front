<p-toast></p-toast>
@if (form) {
<div class="container">
  <form class="row g-3 needs-validation" [formGroup]="form" (ngSubmit)="accion($event)" novalidate>

    <div class="row">
      <div class="col-md-4">
        <label for="codigo" class="form-label">Código</label>
        <input id="codigo" type="text" formControlName="codigo" class="form-control" placeholder="Código" required />
        @if (get('codigo')?.invalid && get('codigo')?.touched) {
          <div class="invalid-feedback">Debe ingresar un código.</div>
        }
      </div>

      <div class="col-md-4">
        <label for="descripcion" class="form-label">Descripción</label>
        <input id="descripcion" type="text" formControlName="descripcion" class="form-control" placeholder="Descripción" required />
        @if (get('descripcion')?.invalid && get('descripcion')?.touched) {
          <div class="invalid-feedback">Debe ingresar una descripción válida.</div>
        }
      </div>

      <div class="col-md-2">
        <label for="color" class="form-label">Color</label>
        <input id="color" type="color" formControlName="color" class="form-control form-control-color" />
      </div>

      <div class="col-md-2">
        <label for="esAdmin" class="form-label">Administrador</label>
        <div class="mb-2">
          <input id="esAdmin" type="checkbox" formControlName="esAdmin" class="btn-check" />
          <label class="btn btn-outline-primary" for="esAdmin">
            @if (get('esAdmin')?.value){
              SÍ
            } @else {
              NO
            }
          </label>
        </div>
      </div>
    </div>

    <!-- <div class="row mt-3">
    </div> -->

    @if (!get('esAdmin')?.value) {
    <div class="row mt-4">
      <div class="col-12">
        <h5>Permisos</h5>
        @if (loading) {
          <app-loading-spinner></app-loading-spinner>
        } @else {
          <div class="table-responsive">
            <p-contextMenu #cm [model]="menuItems"></p-contextMenu>
            <p-table 
              [value]="permisosDisponibles" 
              stripedRows
              [tableStyle]="{'min-width': '50rem'}"
              [rowHover]="true"
              [globalFilterFields]="['modulo', 'codigo']"
              [(contextMenuSelection)]="selectedModulo"
              [contextMenu]="cm"
              #dt
            >
              <ng-template #caption>
                <div class="d-flex justify-content-end">
                  <input 
                    type="text" 
                    class="form-control form-control-sm" 
                    style="max-width: 300px;"
                    placeholder="Buscar..." 
                    (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                  />
                </div>
              </ng-template>
              <ng-template #body let-modulo>
                <!-- @if (modulo.codigo !== 'SYS') { -->
                  <tr [pContextMenuRow]="modulo">
                    <td style="width: 200px; height: 55px; vertical-align: middle;"><strong>{{ modulo.modulo }}</strong></td>
                    @for (accion of getAccionesDelModulo(modulo.codigo); track accion.subcodigo) {
                      <td class="text-center" style="width: 120px; height: 55px; vertical-align: middle;">
                        @let control = getPermisoControl(modulo.codigo, accion.subcodigo);
                        @if (control) {
                          <div class="d-flex flex-column align-items-center gap-1">
                            <input 
                              type="checkbox" 
                              class="form-check-input" 
                              [formControl]="$any(control.get('activo'))"
                            />
                            <small class="">{{ accion.descripcion }}</small>
                          </div>
                        }
                      </td>
                    }
                    @if (getColspanRestante(modulo.codigo) > 0) {
                      <td [attr.colspan]="getColspanRestante(modulo.codigo)" style="height: 55px;"></td>
                    }
                  </tr>
                <!-- } -->
              </ng-template>
            </p-table>
          </div>
        }
      </div>
    </div>
    }

    <div class="row mt-3">
      <div class="col-12 mb-5">
        <button class="btn btn-primary" type="submit" [disabled]="loading">
          @if (modo === 'A') {
            Crear
          } @else if (modo === 'M') {
            Modificar
          }
        </button>
      </div>
    </div>
  </form>
</div>
}